name: üöÄ CI
on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # TODO: Remove after verifying token type for release PR fix
  debug-token-identity:
    name: üîç Debug - Check PAT identity
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Check SHOPIFY_GH_ACCESS_TOKEN identity
        run: |
          echo "Checking SHOPIFY_GH_ACCESS_TOKEN identity..."
          RESPONSE=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/user)
          echo "Login: $(echo $RESPONSE | jq -r '.login')"
          echo "Type: $(echo $RESPONSE | jq -r '.type')"
          echo "Name: $(echo $RESPONSE | jq -r '.name')"
          # Check token prefix (first 4 chars only - safe to log)
          echo "Token prefix: ${TOKEN:0:4}..."
        env:
          TOKEN: ${{ secrets.SHOPIFY_GH_ACCESS_TOKEN }}

  check-node-version:
    name: üîß Node version sync
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate .nvmrc matches dev.yml
        run: |
          NVMRC_VERSION=$(tr -d 'v\n' < .nvmrc)
          # Expects dev.yml format:
          #   - node:
          #       version: vXX.YY.ZZ
          DEV_YML_RAW=$(grep -A3 '^\s*- node:' dev.yml | grep 'version:' | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          DEV_YML_VERSION=$(echo "$DEV_YML_RAW" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          if [ -z "$NVMRC_VERSION" ]; then
            echo "::error::Could not parse version from .nvmrc"
            echo "  .nvmrc contents: '$(cat .nvmrc)'"
            echo "  dev.yml raw:     '$DEV_YML_RAW'"
            exit 1
          fi

          if [ -z "$DEV_YML_RAW" ]; then
            echo "::error::Could not find node version in dev.yml"
            echo "  .nvmrc version:  '$NVMRC_VERSION'"
            echo "  Searched for: '- node:' followed by 'version:' line in dev.yml"
            echo "  Relevant dev.yml lines:"
            grep -A3 'node:' dev.yml | sed 's/^/    /'
            exit 1
          fi

          if [ -z "$DEV_YML_VERSION" ]; then
            echo "::error::dev.yml must specify a FULL Node version (X.Y.Z format)"
            echo ""
            echo "Found: '$DEV_YML_RAW'"
            echo ".nvmrc version: '$NVMRC_VERSION'"
            echo "Expected format: 'vX.Y.Z' (e.g., 'v20.19.5')"
            echo ""
            echo "The Shopify 'dev' tool requires a specific installable version,"
            echo "not just a major version like 'v20'. Nix needs the exact version"
            echo "to fetch from its package cache."
            exit 1
          fi

          NVMRC_MAJOR=$(echo "$NVMRC_VERSION" | cut -d. -f1)
          DEV_YML_MAJOR=$(echo "$DEV_YML_VERSION" | cut -d. -f1)

          if [ "$NVMRC_MAJOR" != "$DEV_YML_MAJOR" ]; then
            echo "::error::Node version mismatch between .nvmrc and dev.yml"
            echo ""
            echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
            echo "‚îÇ  IMPORTANT: This is NOT a configuration oversight!              ‚îÇ"
            echo "‚îÇ                                                                 ‚îÇ"
            echo "‚îÇ  The Shopify 'dev' tool CANNOT read from .nvmrc - it requires   ‚îÇ"
            echo "‚îÇ  an explicit version. These files serve different tools:        ‚îÇ"
            echo "‚îÇ    ‚Ä¢ .nvmrc  ‚Üí used by nvm (flexible major version like 'v20')  ‚îÇ"
            echo "‚îÇ    ‚Ä¢ dev.yml ‚Üí used by dev tool (needs exact version 'v20.x.x') ‚îÇ"
            echo "‚îÇ                                                                 ‚îÇ"
            echo "‚îÇ  Both files MUST be updated TOGETHER when changing Node version.‚îÇ"
            echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
            echo ""
            echo "Current state:"
            echo "  .nvmrc major version:  v$NVMRC_MAJOR"
            echo "  dev.yml major version: v$DEV_YML_MAJOR"
            echo ""
            echo "To fix: Update both files to use the same Node major version."
            exit 1
          fi

          echo "‚úÖ Node versions in sync (major version: v$NVMRC_MAJOR)"

  lint:
    name: ‚¨£ ESLint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-lint-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          run_install: false

      - name: ‚éî Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: üì• Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: üî¨ Lint
        run: pnpm run lint

  format:
    name: ‚¨£ Prettier
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-format-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          run_install: false

      - name: ‚éî Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: üì• Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: üî¨ Check Formatting
        run: pnpm run format:check

  typecheck:
    name: Typescript
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-typecheck-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          run_install: false

      - name: ‚éî Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: üì• Install dependencies
        run: |
          pnpm install --frozen-lockfile

      # Enabling the turbo cache causes deployments to fail intermittently.
      # The build step fails with dependency issues. More investigation needed.
      # - name: üíæ Turbo cache
      #   id: turbo-cache
      #   uses: actions/cache@v3
      #   with:
      #     path: |
      #       node_modules/.cache/turbo
      #       **/.turbo
      #     key: turbo-${{ github.job }}-${{ github.ref_name }}-${{ github.sha }}
      #     restore-keys: |
      #       turbo-${{ github.job }}-${{ github.ref_name }}-

      - name: üì¶ Build packages and templates
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false pnpm run build:all

      - name: ‚úÖ Typecheck
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false pnpm run typecheck

      - name: üßë‚Äçüíª CLI manifest check
        run: 'test -z "$(git status --porcelain "packages/cli/oclif.manifest.json" )" || { echo -e "Run pnpm --dir packages/cli run generate:manifest before pushing new commands or flags. Diff here:\n\n$(git diff)" ; exit 1; }'

  test_e2e:
    name: ‚¨£ E2E tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: ci-e2e-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          run_install: false

      - name: ‚éî Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: üì• Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: üì¶ Build packages and templates
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false pnpm run build:all

      - name: üé≠ Install Playwright Chromium
        run: pnpm exec playwright install chromium --with-deps

      - name: üîê Install ejson
        run: |
          sudo apt-get update
          sudo apt-get install -y golang-go
          go install github.com/Shopify/ejson/cmd/ejson@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: üß™ Run E2E tests
        run: pnpm exec playwright test
        env:
          EJSON_PRIVATE_KEY: ${{ secrets.EJSON_PRIVATE_KEY }}

      - name: üì§ Upload Playwright Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ always() && !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          if-no-files-found: warn
          retention-days: 30

  test_unit:
    name: ‚¨£ Unit tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-test-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          run_install: false

      - name: ‚éî Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: üì• Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: üì¶ Build packages and templates
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false pnpm run build:all

      - name: üî¨ Test
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false pnpm run test

  validate_recipes:
    name: ‚¨£ Validate Recipes
    # TEMPORARILY DISABLED: Recipe system is being re-evaluated.
    # Remove this line to re-enable.
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-validate-recipes-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          run_install: false

      - name: ‚éî Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: üì• Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: üì¶ Build packages
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false pnpm run build:pkg

      - name: üìù Validate schema
        working-directory: cookbook
        run: pnpm run cookbook -- schema && git diff --exit-code recipe.schema.json

      - name: üßê Validate Recipes
        working-directory: cookbook
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false pnpm run cookbook -- validate
