name: ğŸš€ CI
on: [pull_request]

jobs:
  check-node-version:
    name: ğŸ”§ Node version sync
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate .nvmrc matches dev.yml
        run: |
          NVMRC_VERSION=$(tr -d 'v\n' < .nvmrc)
          DEV_YML_RAW=$(grep "node:" dev.yml | grep -oE "'v?[^']+'" | tr -d "'" | head -1)
          DEV_YML_VERSION=$(echo "$DEV_YML_RAW" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          if [ -z "$NVMRC_VERSION" ]; then
            echo "::error::Could not parse version from .nvmrc"
            exit 1
          fi

          if [ -z "$DEV_YML_RAW" ]; then
            echo "::error::Could not find node: directive in dev.yml"
            exit 1
          fi

          if [ -z "$DEV_YML_VERSION" ]; then
            echo "::error::dev.yml must specify a FULL Node version (X.Y.Z format)"
            echo ""
            echo "Found: '$DEV_YML_RAW'"
            echo "Expected format: 'vX.Y.Z' (e.g., 'v20.19.5')"
            echo ""
            echo "The Shopify 'dev' tool requires a specific installable version,"
            echo "not just a major version like 'v20'. Nix needs the exact version"
            echo "to fetch from its package cache."
            exit 1
          fi

          NVMRC_MAJOR=$(echo "$NVMRC_VERSION" | cut -d. -f1)
          DEV_YML_MAJOR=$(echo "$DEV_YML_VERSION" | cut -d. -f1)

          if [ "$NVMRC_MAJOR" != "$DEV_YML_MAJOR" ]; then
            echo "::error::Node version mismatch between .nvmrc and dev.yml"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚  IMPORTANT: This is NOT a configuration oversight!              â”‚"
            echo "â”‚                                                                 â”‚"
            echo "â”‚  The Shopify 'dev' tool CANNOT read from .nvmrc - it requires   â”‚"
            echo "â”‚  an explicit version. These files serve different tools:        â”‚"
            echo "â”‚    â€¢ .nvmrc  â†’ used by nvm (flexible major version like 'v20')  â”‚"
            echo "â”‚    â€¢ dev.yml â†’ used by dev tool (needs exact version 'v20.x.x') â”‚"
            echo "â”‚                                                                 â”‚"
            echo "â”‚  Both files MUST be updated TOGETHER when changing Node version.â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "Current state:"
            echo "  .nvmrc major version:  v$NVMRC_MAJOR"
            echo "  dev.yml major version: v$DEV_YML_MAJOR"
            echo ""
            echo "To fix: Update both files to use the same Node major version."
            exit 1
          fi

          echo "âœ… Node versions in sync (major version: v$NVMRC_MAJOR)"

  lint:
    name: â¬£ ESLint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-lint-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          npm rebuild

      - name: ğŸ”¬ Lint
        run: npm run lint

  format:
    name: â¬£ Prettier
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-format-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          npm rebuild

      - name: ğŸ”¬ Check Formatting
        run: npm run format:check

  typecheck:
    name: Typescript
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-typecheck-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          npm rebuild

      # Enabling the turbo cache causes deployments to fail intermittently.
      # The build step fails with dependency issues. More investigation needed.
      # - name: ğŸ’¾ Turbo cache
      #   id: turbo-cache
      #   uses: actions/cache@v3
      #   with:
      #     path: |
      #       node_modules/.cache/turbo
      #       **/.turbo
      #     key: turbo-${{ github.job }}-${{ github.ref_name }}-${{ github.sha }}
      #     restore-keys: |
      #       turbo-${{ github.job }}-${{ github.ref_name }}-

      - name: ğŸ“¦ Build packages and templates
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false npm run build:all

      - name: âœ… Typecheck
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false npm run typecheck

      - name: ğŸ§‘â€ğŸ’» CLI manifest check
        run: 'test -z "$(git status --porcelain "packages/cli/oclif.manifest.json" )" || { echo -e "Run npm generate:manifest in packages/cli before pushing new commands or flags. Diff here:\n\n$(git diff)" ; exit 1; }'

  test_e2e:
    name: â¬£ E2E tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-e2e-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          npm rebuild

      - name: ğŸ“¦ Build packages and templates
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false npm run build:all

      - name: ğŸ­ Install Playwright Chromium
        run: npx playwright install chromium --with-deps

      - name: ğŸ” Install ejson
        run: |
          sudo apt-get update
          sudo apt-get install -y golang-go
          go install github.com/Shopify/ejson/cmd/ejson@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: ğŸ§ª Run E2E tests
        run: npx playwright test --workers=1
        env:
          EJSON_PRIVATE_KEY: ${{ secrets.EJSON_PRIVATE_KEY }}

      - name: ğŸ“¤ Upload Playwright Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  test_unit:
    name: â¬£ Unit tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-test-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          npm rebuild

      - name: ğŸ“¦ Build packages and templates
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false npm run build:all

      - name: ğŸ”¬ Test
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false npm run test

  validate_recipes:
    name: â¬£ Validate Recipes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-validate-recipes-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: â” Setup node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          npm rebuild

      - name: ğŸ“¦ Build packages
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false npm run build:pkg

      - name: ğŸ“¥ Install dependencies (cookbook)
        working-directory: cookbook
        run: |
          npm ci
          npm rebuild

      - name: ğŸ“ Validate schema
        working-directory: cookbook
        run: npm run cookbook -- schema && git diff --exit-code recipe.schema.json

      - name: ğŸ§ Validate Recipes
        working-directory: cookbook
        run: SHOPIFY_HYDROGEN_FLAG_LOCKFILE_CHECK=false npm run cookbook -- validate
