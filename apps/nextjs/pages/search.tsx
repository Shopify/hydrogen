import Head from 'next/head';
import Image from 'next/image';
import styles from '../styles/Home.module.css';
import {graphql} from '../gql/gql';
import {request} from 'graphql-request';
import type {GetServerSideProps} from 'next';
import {shopClient} from '../src/shopify-client';
import type {SearchQuery} from '../gql/graphql';
import {
  type StorefrontApiResponseOk,
  useShop,
  AnalyticsPageType,
} from '@shopify/storefront-kit-react';
import Link from 'next/link';

export const getServerSideProps: GetServerSideProps = async () => {
  // @TODO figure out how to get the client's IP address correctly and accurately.
  // const buyerIp =
  //   req.headers["x-real-ip"] ??
  //   req.headers["x-forwarded-for"] ??
  //   req.socket.remoteAddress;

  try {
    const searchTerm = 'liquid';
    const response = await request({
      url: shopClient.getStorefrontApiUrl(),
      document: query,
      variables: {
        searchTerm,
      },
      // @TODO: convert to 'getPrivateTokenHeaders({buyerIp})'
      requestHeaders: shopClient.getPublicTokenHeaders(),
    });

    // @TODO I don't love how we do this with 'errors' and 'data'
    return {
      props: {
        data: response,
        errors: null,
        analytics: {
          pageType: AnalyticsPageType.search,
          searchString: searchTerm,
        },
      },
    };
  } catch (err) {
    console.error(err);
    return {props: {data: null, errors: [(err as Error).toString()]}};
  }
};

export default function Search({
  data,
  errors,
}: StorefrontApiResponseOk<SearchQuery>) {
  const {storeDomain} = useShop();

  if (!data || errors) {
    console.error(errors);
    return <div>Whoops there was an error! Please refresh and try again.</div>;
  }

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <h1>Search Page</h1>
        <div>Storefront API Domain: {storeDomain}</div>
        <br />
        <Link href="/">Back to Home</Link>
        <Link href="/collection">Go to Collection</Link>
        <Link href="/product">Go to Product</Link>
      </main>

      <footer className={styles.footer}>
        <a
          href="https://vercel.com?utm_source=hydrogen-react-monorepo"
          target="_blank"
          rel="noopener noreferrer"
        >
          Powered by{' '}
          <span className={styles.logo}>
            <Image src="/vercel.svg" alt="Vercel Logo" width={72} height={16} />
          </span>
        </a>
      </footer>
    </div>
  );
}

const query = graphql(`
  query Search($searchTerm: String) {
    products(first: 1, sortKey: RELEVANCE, query: $searchTerm) {
      pageInfo {
        startCursor
        endCursor
        hasNextPage
        hasPreviousPage
      }
    }
  }
`);
